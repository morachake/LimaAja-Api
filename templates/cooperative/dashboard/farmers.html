{% extends 'cooperative/dashboard_base.html' %}
{% load static %}

{% block title %}Farmers - Lima-Aja Cooperative Dashboard{% endblock %}

{% block content %}
<div class="page-title">
    <h1>Farmers Management</h1>
    <p>Manage your cooperative's farmers</p>
</div>

<div class="card table-card">
    <div class="table-header">
        <h3><i class="fas fa-users"></i> Farmers List</h3>
        <button class="btn btn-primary" id="add-farmer-btn"><i class="fas fa-plus"></i> Add Farmer</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Phone Number</th>
                <th>Location</th>
                <th>Date Added</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for farmer in farmers %}
            <tr>
                <td>{{ farmer.name }}</td>
                <td>{{ farmer.phone_number }}</td>
                <td>{{ farmer.location }}</td>
                <td>{{ farmer.created_at|date:"M d, Y" }}</td>
                <td>
                    <div class="farmer-actions">
                        <button class="edit-farmer" data-id="{{ farmer.id }}" data-name="{{ farmer.name }}" data-phone="{{ farmer.phone_number }}" data-location="{{ farmer.location }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-farmer" data-id="{{ farmer.id }}" data-name="{{ farmer.name }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px;">
                    <p>No farmers added yet. Click "Add Farmer" to add your first farmer.</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add/Edit Farmer Modal -->
<div class="modal-backdrop" id="farmer-modal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modal-title">Add New Farmer</h2>
            <button class="close-btn" id="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="farmer-form" method="post">
                {% csrf_token %}
                <input type="hidden" id="farmer-id" name="farmer_id">
                <div class="farmer-form-grid">
                    <div class="form-group">
                        <label for="farmer-name">Farmer Name</label>
                        <input type="text" id="farmer-name" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="farmer-phone">Phone Number</label>
                        <input type="tel" id="farmer-phone" name="phone_number" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="farmer-location">Location/Region</label>
                    <input type="text" id="farmer-location" name="location" class="form-control" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-farmer">Cancel</button>
            <button type="button" class="btn btn-primary" id="save-farmer">Save Farmer</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="delete-modal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2>Confirm Delete</h2>
            <button class="close-btn" id="close-delete-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete the farmer <strong id="delete-farmer-name"></strong>?</p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-delete">Cancel</button>
            <form id="delete-farmer-form" method="post">
                {% csrf_token %}
                <input type="hidden" id="delete-farmer-id" name="farmer_id">
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Modal elements
        const farmerModal = document.getElementById('farmer-modal');
        const deleteModal = document.getElementById('delete-modal');
        const modalTitle = document.getElementById('modal-title');
        const farmerForm = document.getElementById('farmer-form');
        const farmerId = document.getElementById('farmer-id');
        const farmerName = document.getElementById('farmer-name');
        const farmerPhone = document.getElementById('farmer-phone');
        const farmerLocation = document.getElementById('farmer-location');
        const deleteFarmerName = document.getElementById('delete-farmer-name');
        const deleteFarmerId = document.getElementById('delete-farmer-id');
        
        // Buttons
        const addFarmerBtn = document.getElementById('add-farmer-btn');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelFarmerBtn = document.getElementById('cancel-farmer');
        const saveFarmerBtn = document.getElementById('save-farmer');
        const closeDeleteModalBtn = document.getElementById('close-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        
        // Edit and delete buttons
        const editButtons = document.querySelectorAll('.edit-farmer');
        const deleteButtons = document.querySelectorAll('.delete-farmer');
        
        // Open add farmer modal
        addFarmerBtn.addEventListener('click', function() {
            modalTitle.textContent = 'Add New Farmer';
            farmerForm.reset();
            farmerId.value = '';
            farmerModal.style.display = 'flex';
        });
        
        // Close farmer modal
        function closeFarmerModal() {
            farmerModal.style.display = 'none';
        }
        
        closeModalBtn.addEventListener('click', closeFarmerModal);
        cancelFarmerBtn.addEventListener('click', closeFarmerModal);
        
        // Close delete modal
        function closeDeleteModal() {
            deleteModal.style.display = 'none';
        }
        
        closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        
        // Edit farmer
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const name = this.dataset.name;
                const phone = this.dataset.phone;
                const location = this.dataset.location;
                
                modalTitle.textContent = 'Edit Farmer';
                farmerId.value = id;
                farmerName.value = name;
                farmerPhone.value = phone;
                farmerLocation.value = location;
                
                farmerModal.style.display = 'flex';
            });
        });
        
        // Delete farmer
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const name = this.dataset.name;
                
                deleteFarmerId.value = id;
                deleteFarmerName.textContent = name;
                
                deleteModal.style.display = 'flex';
            });
        });
        
        // Save farmer
        saveFarmerBtn.addEventListener('click', function() {
            if (farmerForm.checkValidity()) {
                const isEdit = farmerId.value !== '';
                const url = isEdit ? `/cooperative/api/farmers/${farmerId.value}/update/` : '/cooperative/api/farmers/create/';
                const method = isEdit ? 'PUT' : 'POST';
                
                const formData = new FormData(farmerForm);
                
                fetch(url, {
                    method: method,
                    body: JSON.stringify({
                        name: formData.get('name'),
                        phone_number: formData.get('phone_number'),
                        location: formData.get('location')
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.detail || 'An error occurred');
                        });
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            } else {
                farmerForm.reportValidity();
            }
        });
    });
</script>
{% endblock %}

